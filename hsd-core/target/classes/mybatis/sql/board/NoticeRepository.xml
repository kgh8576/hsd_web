<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.hsd.core.board.repository.NoticeRepository">

    <resultMap id="simpleNoticeResult" type="notice">
        <id		property="idx" column="IDX" />
        <result property="title" column="TITLE" />
        <result property="contents" column="CONTENTS" />
        <result property="hits" column="HITS" />
        <result property="useFlag" column="USE_FLAG" />
        <result property="updDttm" column="UPD_DTTM" />
        <result property="regDttm" column="REG_DTTM" />

        <result property="prevIdx" column="prevIdx" />
        <result property="prevTitle" column="prevTitle" />
        <result property="nextIdx" column="nextIdx" />
        <result property="nextTitle" column="nextTitle" />
    </resultMap>

    <!-- where 문 -->
    <sql id="boardCondition">
        <where>
            USE_FLAG = 'Y'
            <if test="searchInfo != null">
                <foreach collection="searchInfo.entrySet()" index="key" item="val">
                    <!-- key = 검색조건, val = 검색값 -->
                    <choose>
                        <when test="key == 'all'">
                            AND (TITLE LIKE CONCAT('%',#{val},'%') OR CONTENTS LIKE CONCAT('%',#{val},'%'))
                        </when>
                    </choose>
                </foreach>
            </if>
        </where>
    </sql>

    <!-- 게시판 count -->
    <select id="listNoticeCnt" resultType="int">
        /* kr.co.core.board.repository.NoticeRepository.listNoticeCnt */
        SELECT	COUNT(*) CNT
        FROM	TB_NOTICE
        <include refid="boardCondition"/>
    </select>


    <!-- 게시판 목록 -->
    <select id="listNotice" resultMap="simpleNoticeResult">
        /* kr.co.core.board.repository.NoticeRepository.listNotice */
        SELECT	*
        FROM	TB_NOTICE
        <include refid="boardCondition"/>
        <include refid="Common.sort"/>
        <include refid="Common.limit"/>
    </select>

    <!-- 조회수 증가 -->
    <update id="updateNoticeHits">
        UPDATE TB_NOTICE
        SET HITS = IFNULL(HITS, 0)+1
        WHERE IDX = #{idx} AND USE_FLAG = 'Y'
    </update>

    <!-- 게시판 상세 -->
    <select id="getNotice" resultMap="simpleNoticeResult">
        /* kr.co.core.board.repository.NoticeRepository.getNotice */
        SELECT	*
        FROM  TB_NOTICE
        WHERE IDX = #{idx} AND USE_FLAG = 'Y'
    </select>

    <!-- 이전글 -->
    <select id="getPrevNotice" resultMap="simpleNoticeResult">
        SELECT IDX as prevIdx, TITLE as prevTitle FROM TB_NOTICE WHERE USE_FLAG = 'Y' AND IDX  <![CDATA[ < ]]>  #{idx} ORDER BY IDX DESC LIMIT 1
    </select>

    <!-- 다음글 -->
    <select id="getNextNotice" resultMap="simpleNoticeResult">
        SELECT IDX as nextIdx, TITLE as nextTitle FROM TB_NOTICE WHERE USE_FLAG = 'Y' AND IDX  <![CDATA[ > ]]> #{idx} ORDER BY IDX ASC LIMIT 1
    </select>
</mapper>